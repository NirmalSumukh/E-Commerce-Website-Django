{% extends "oscar/dashboard/layout.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}Edit Post: {{ form.instance.title }}{% else %}Create New Post{% endif %} | {{ block.super }}
{% endblock %}

{% block extrahead %}
{{ block.super }}
{{ form.media }}

<!-- Auto-save status styles -->
<style>
.auto-save-status {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.auto-save-saving {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.auto-save-saved {
    background: #d1edff;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.auto-save-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.image-preview-container {
    position: relative;
    display: inline-block;
}

.image-preview {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.remove-image {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 14px;
    cursor: pointer;
}

.form-section {
    background: #f8f9fa;
    border-left: 4px solid #0d6efd;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 0 8px 8px 0;
}

.validation-error {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.character-counter {
    font-size: 0.8rem;
    color: #6c757d;
    float: right;
}

.character-counter.warning {
    color: #fd7e14;
}

.character-counter.danger {
    color: #dc3545;
}
</style>
{% endblock %}

{% block breadcrumbs %}
<nav aria-label="You are here:">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'blog:staff_list' %}">Blog Posts</a></li>
        <li class="breadcrumb-item active">
            {% if form.instance.pk %}Edit Post{% else %}Create Post{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block header %}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1>
                <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %} me-2"></i>
                {% if form.instance.pk %}Edit Post{% else %}Create New Post{% endif %}
            </h1>
            {% if form.instance.pk %}
            <small class="text-muted">Last saved: <span id="lastSaved">{{ form.instance.updated_at|date:"M d, Y H:i" }}</span></small>
            {% endif %}
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{% url 'blog:staff_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Posts
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_content %}
<!-- Auto-save status indicator -->
<div id="autoSaveStatus" class="auto-save-status" style="display: none;">
    <i class="fas fa-spinner fa-spin me-2"></i>
    <span id="saveStatusText">Saving...</span>
</div>

<form id="postForm" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    
    <div class="row">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            <!-- Basic Information Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Post Information
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Title Field -->
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                            Title <span class="text-danger">*</span>
                        </label>
                        {{ form.title }}
                        <div class="character-counter" id="titleCounter">0/200</div>
                        {% if form.title.errors %}
                            <div class="validation-error">{{ form.title.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Slug Display (for existing posts) -->
                    {% if form.instance.pk %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">URL Slug</label>
                        <div class="form-control-plaintext">
                            <code>{{ form.instance.slug }}</code>
                            <small class="text-muted d-block">
                                Full URL: 
                                <a href="{% url 'blog:detail' form.instance.slug %}" target="_blank">
                                    {{ request.build_absolute_uri }}{% url 'blog:detail' form.instance.slug %}
                                </a>
                            </small>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Category Field -->
                    <div class="mb-3">
                        <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">Category</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="validation-error">{{ form.category.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Excerpt Field -->
                    <div class="mb-3">
                        <label for="{{ form.excerpt.id_for_label }}" class="form-label fw-bold">
                            Excerpt
                            <small class="text-muted">(Optional - used for previews and SEO)</small>
                        </label>
                        {{ form.excerpt }}
                        <div class="character-counter" id="excerptCounter">0/300</div>
                        <small class="form-text text-muted">
                            A brief summary of your post. If left empty, the first few lines of content will be used.
                        </small>
                        {% if form.excerpt.errors %}
                            <div class="validation-error">{{ form.excerpt.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-align-left me-2"></i>Content <span class="text-danger">*</span>
                    </h5>
                </div>
                <div class="card-body">
                    {{ form.content }}
                    {% if form.content.errors %}
                        <div class="validation-error mt-2">{{ form.content.errors.0 }}</div>
                    {% endif %}
                    <small class="form-text text-muted mt-2 d-block">
                        <i class="fas fa-lightbulb me-1"></i>
                        Tip: Use headings, images, and formatting to make your content engaging and readable.
                    </small>
                </div>
            </div>

            <!-- Featured Image Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-image me-2"></i>Featured Image
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Current Image Preview -->
                    {% if form.instance.featured %}
                    <div id="currentImageContainer" class="mb-3">
                        <label class="form-label fw-bold">Current Image:</label>
                        <div class="image-preview-container">
                            <img src="{{ form.instance.featured.url }}" 
                                 alt="Current featured image" 
                                 class="image-preview"
                                 id="currentImage">
                            <button type="button" 
                                    class="remove-image" 
                                    onclick="removeCurrentImage()"
                                    title="Remove current image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- File Upload -->
                    <div class="mb-3">
                        <label for="{{ form.featured.id_for_label }}" class="form-label fw-bold">
                            {% if form.instance.featured %}Upload New Image{% else %}Upload Image{% endif %}
                        </label>
                        {{ form.featured }}
                        {% if form.featured.errors %}
                            <div class="validation-error">{{ form.featured.errors.0 }}</div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Recommended size: 1200x630px. Supported formats: JPG, PNG, WebP (max 5MB)
                        </small>
                    </div>

                    <!-- New Image Preview -->
                    <div id="newImagePreview" style="display: none;">
                        <label class="form-label fw-bold">Preview:</label>
                        <div class="image-preview-container">
                            <img id="previewImage" class="image-preview" alt="Image preview">
                            <button type="button" 
                                    class="remove-image" 
                                    onclick="removeNewImage()"
                                    title="Remove new image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tags Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tags me-2"></i>Tags
                    </h5>
                </div>
                <div class="card-body">
                    {{ form.tags }}
                    {% if form.tags.errors %}
                        <div class="validation-error">{{ form.tags.errors.0 }}</div>
                    {% endif %}
                    <small class="form-text text-muted">
                        Separate tags with commas. Tags help readers find related content.
                    </small>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Publish Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Publish Settings
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Status Field -->
                    <div class="mb-3">
                        <label for="{{ form.status.id_for_label }}" class="form-label fw-bold">Status</label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <div class="validation-error">{{ form.status.errors.0 }}</div>
                        {% endif %}
                        <small class="form-text text-muted" id="statusHelp">
                            Draft posts are only visible to staff members.
                        </small>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" name="action" value="save_draft" class="btn btn-outline-secondary">
                            <i class="fas fa-save me-2"></i>Save as Draft
                        </button>
                        <button type="submit" name="action" value="publish" class="btn btn-success">
                            <i class="fas fa-rocket me-2"></i>
                            {% if form.instance.status == 'published' %}Update{% else %}Publish{% endif %}
                        </button>
                        {% if form.instance.pk %}
                        <a href="{% url 'blog:delete' form.instance.slug %}" 
                           class="btn btn-danger"
                           onclick="return confirm('Are you sure you want to delete this post?')">
                            <i class="fas fa-trash me-2"></i>Delete Post
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Post Information Panel -->
            {% if form.instance.pk %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info me-2"></i>Post Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong>Created:</strong><br>
                            <small class="text-muted">
                                {{ form.instance.created_at|date:"F d, Y g:i A" }}
                                <br>({{ form.instance.created_at|timesince }} ago)
                            </small>
                        </div>
                        <div class="col-12 mb-2">
                            <strong>Last Updated:</strong><br>
                            <small class="text-muted">
                                {{ form.instance.updated_at|date:"F d, Y g:i A" }}
                                <br>({{ form.instance.updated_at|timesince }} ago)
                            </small>
                        </div>
                        {% if form.instance.published_at %}
                        <div class="col-12 mb-2">
                            <strong>Published:</strong><br>
                            <small class="text-muted">
                                {{ form.instance.published_at|date:"F d, Y g:i A" }}
                                <br>({{ form.instance.published_at|timesince }} ago)
                            </small>
                        </div>
                        {% endif %}
                        <div class="col-12 mb-2">
                            <strong>Author:</strong><br>
                            <small class="text-muted">{{ form.instance.author.get_full_name|default:form.instance.author.username }}</small>
                        </div>
                        <div class="col-12 mb-2">
                            <strong>Word Count:</strong><br>
                            <small class="text-muted" id="wordCount">{{ form.instance.content|wordcount }} words</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Auto-save Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-save me-2"></i>Auto-save
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoSaveEnabled" checked>
                        <label class="form-check-label" for="autoSaveEnabled">
                            Enable auto-save
                        </label>
                    </div>
                    <small class="form-text text-muted">
                        Automatically saves your work every 30 seconds.
                    </small>
                    <div id="autoSaveTimer" class="mt-2 text-muted small" style="display: none;">
                        Next save in: <span id="countdown">30</span>s
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    {% if form.instance.pk and form.instance.status == 'published' %}
                    <a href="{% url 'blog:detail' form.instance.slug %}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm d-block mb-2">
                        <i class="fas fa-external-link-alt me-2"></i>View Post
                    </a>
                    {% endif %}
                    <button type="button" 
                            class="btn btn-outline-info btn-sm d-block mb-2"
                            onclick="previewPost()">
                        <i class="fas fa-eye me-2"></i>Preview
                    </button>
                    <button type="button" 
                            class="btn btn-outline-secondary btn-sm d-block"
                            onclick="resetForm()">
                        <i class="fas fa-undo me-2"></i>Reset Form
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extrajs %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character counters
    setupCharacterCounter('id_title', 'titleCounter', 200);
    setupCharacterCounter('id_excerpt', 'excerptCounter', 300);

    // Image preview functionality
    setupImagePreview();

    // Form validation
    setupFormValidation();

    // Auto-save functionality
    setupAutoSave();

    // Status change handler
    setupStatusHandler();
});

function setupCharacterCounter(fieldId, counterId, maxLength) {
    const field = document.getElementById(fieldId);
    const counter = document.getElementById(counterId);
    
    if (field && counter) {
        function updateCounter() {
            const length = field.value.length;
            counter.textContent = `${length}/${maxLength}`;
            
            if (length > maxLength * 0.9) {
                counter.className = 'character-counter danger';
            } else if (length > maxLength * 0.8) {
                counter.className = 'character-counter warning';
            } else {
                counter.className = 'character-counter';
            }
        }
        
        field.addEventListener('input', updateCounter);
        updateCounter(); // Initial count
    }
}

function setupImagePreview() {
    const fileInput = document.getElementById('id_featured');
    const previewContainer = document.getElementById('newImagePreview');
    const previewImage = document.getElementById('previewImage');
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
}

function removeCurrentImage() {
    if (confirm('Are you sure you want to remove the current featured image?')) {
        document.getElementById('currentImageContainer').style.display = 'none';
        // Add a hidden input to mark image for removal
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'remove_featured';
        hiddenInput.value = 'true';
        document.getElementById('postForm').appendChild(hiddenInput);
    }
}

function removeNewImage() {
    document.getElementById('id_featured').value = '';
    document.getElementById('newImagePreview').style.display = 'none';
}

function setupFormValidation() {
    const form = document.getElementById('postForm');
    const titleField = document.getElementById('id_title');
    const contentField = document.querySelector('[name="content"]');
    
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Clear previous errors
        document.querySelectorAll('.validation-error').forEach(el => {
            if (!el.textContent.includes('This field is required')) {
                el.style.display = 'none';
            }
        });
        
        // Title validation
        if (!titleField.value.trim()) {
            showValidationError(titleField, 'Title is required');
            isValid = false;
        }
        
        // Content validation
        if (contentField && !contentField.value.trim()) {
            showValidationError(contentField, 'Content is required');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            showToast('Please correct the errors before submitting', 'error');
        }
    });
}

function showValidationError(field, message) {
    let errorDiv = field.parentNode.querySelector('.validation-error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'validation-error';
        field.parentNode.appendChild(errorDiv);
    }
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    field.focus();
}

function setupAutoSave() {
    const autoSaveEnabled = document.getElementById('autoSaveEnabled');
    const form = document.getElementById('postForm');
    const statusDiv = document.getElementById('autoSaveStatus');
    const statusText = document.getElementById('saveStatusText');
    const timerDiv = document.getElementById('autoSaveTimer');
    const countdown = document.getElementById('countdown');
    
    let autoSaveTimer;
    let countdownTimer;
    let countdownValue = 30;
    
    function startAutoSave() {
        if (!autoSaveEnabled.checked) return;
        
        autoSaveTimer = setInterval(function() {
            if (form.checkValidity()) {
                performAutoSave();
            }
        }, 30000); // 30 seconds
        
        startCountdown();
    }
    
    function startCountdown() {
        timerDiv.style.display = 'block';
        countdownValue = 30;
        
        countdownTimer = setInterval(function() {
            countdownValue--;
            countdown.textContent = countdownValue;
            
            if (countdownValue <= 0) {
                countdownValue = 30;
                countdown.textContent = countdownValue;
            }
        }, 1000);
    }
    
    function performAutoSave() {
        const formData = new FormData(form);
        formData.append('auto_save', 'true');
        
        // Show saving status
        statusDiv.style.display = 'block';
        statusDiv.className = 'auto-save-status auto-save-saving';
        statusText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Auto-saving...';
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.className = 'auto-save-status auto-save-saved';
                statusText.innerHTML = '<i class="fas fa-check me-2"></i>Auto-saved';
                document.getElementById('lastSaved').textContent = new Date().toLocaleString();
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            } else {
                throw new Error('Auto-save failed');
            }
        })
        .catch(error => {
            statusDiv.className = 'auto-save-status auto-save-error';
            statusText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Auto-save failed';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        });
    }
    
    autoSaveEnabled.addEventListener('change', function() {
        if (this.checked) {
            startAutoSave();
        } else {
            clearInterval(autoSaveTimer);
            clearInterval(countdownTimer);
            timerDiv.style.display = 'none';
        }
    });
    
    // Start auto-save if enabled
    if (autoSaveEnabled.checked) {
        startAutoSave();
    }
}

function setupStatusHandler() {
    const statusField = document.getElementById('id_status');
    const statusHelp = document.getElementById('statusHelp');
    
    function updateStatusHelp() {
        if (statusField.value === 'published') {
            statusHelp.textContent = 'Published posts are visible to all visitors.';
        } else {
            statusHelp.textContent = 'Draft posts are only visible to staff members.';
        }
    }
    
    statusField.addEventListener('change', updateStatusHelp);
    updateStatusHelp(); // Initial setup
}

function previewPost() {
    const title = document.getElementById('id_title').value;
    const content = document.querySelector('[name="content"]').value;
    
    if (!title || !content) {
        alert('Please enter a title and content to preview the post.');
        return;
    }
    
    // Open preview in new window
    const previewWindow = window.open('', 'preview', 'width=800,height=600');
    previewWindow.document.write(`
        <html>
        <head>
            <title>Preview: ${title}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { padding: 2rem; }
                .preview-header { border-bottom: 1px solid #dee2e6; padding-bottom: 1rem; margin-bottom: 2rem; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="preview-header">
                    <h1>${title}</h1>
                    <p class="text-muted">Preview Mode</p>
                </div>
                <div class="content">${content}</div>
            </div>
        </body>
        </html>
    `);
}

function resetForm() {
    if (confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
        document.getElementById('postForm').reset();
        document.getElementById('newImagePreview').style.display = 'none';
        
        // Reset character counters
        setupCharacterCounter('id_title', 'titleCounter', 200);
        setupCharacterCounter('id_excerpt', 'excerptCounter', 300);
    }
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 1060; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}
